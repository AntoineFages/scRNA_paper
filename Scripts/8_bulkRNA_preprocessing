#Script 8. Bulk RNA preprocessing, mapping and generation of count matrix

##### TRIMMOMATIC #####

sample = "XXX" #sample ID
illuminaClip = "XXX" #path to illumina clip 

read1=$(cat list_of_fastq.txt | grep ${sample} | grep "R1") #list_of_fastq.txt is a text file containing all paths to fastq files
read2=$(cat list_of_fastq.txt | grep ${sample} | grep "R1") #list_of_fastq.txt is a text file containing all paths to fastq files

java -jar /scicore/soft/apps/Trimmomatic/0.39-Java-1.8/trimmomatic-0.39.jar PE -version -threads 4 -phred33 $read1 $read2 \
${sample}.1.trimmed.fastq ${sample}.1.untrimmed.fastq ${sample}.2.trimmed.fastq ${sample}.2.untrimmed.fastq \
ILLUMINACLIP:$illuminaClip:2:30:10:2 SLIDINGWINDOW:4:15 MINLEN:30


##### STAR MAPPING #####

STAR_genome_directory = "XXX" #directory to put output of STAR genome generation script
genome_fasta = "XXX"  #genome fasta file
gtf_file = "XXX" #genome annotation file in gtf format

#STAR genome generation
STAR  --runMode genomeGenerate  --runThreadN 8  --genomeDir STAR_genome_directory \
--genomeFastaFiles genome_fasta --sjdbGTFfile gtf_file \
--sjdbGTFfeatureExon exon  --sjdbOverhang 50

#Mapping
read1=$(cat list_of_Trimmomatic_fastq.txt | grep ${sample}| grep "1.trimmed") #list_of_Trimmomatic_fastq.txt is a text file containing all paths to output fastqs from Trimmomatic
read2=$(cat list_of_Trimmomatic_fastq.txt | grep ${sample} | grep "2.trimmed") #list_of_Trimmomatic_fastq.txt is a text file containing all paths to output fastqs from Trimmomatic

STAR --outFilterMultimapNmax 1 --genomeDir STAR_genome_directory \
--readFilesIn $read1 $read2 \
--outSAMtype BAM SortedByCoordinate --outReadsUnmapped Fastx 
--runThreadN 8 --limitBAMsortRAM 40000000000  \
--outFileNamePrefix ${sample}.STAR 


##### HTSeq #####

#HTSeq is used to count reads mapping to genomic features
sample_bam_path = "XXX" #path to bam file generated by STAR for each sample
htseq-count -f bam -r pos -s no -m union -s no -t gene  ${sample_bam_path} gtf_file  > ${sample_bam_path}.HTseq.sam

#This is followed by a manual merging of all count vectors for all samples into a matrix, here called Matrix

