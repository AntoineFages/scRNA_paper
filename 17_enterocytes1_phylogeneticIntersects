#!/usr/bin/env Rscript
#Script 17. R script for identifying ecologically relevant genes in enterocytes 1

library(Seurat)
library(dplyr)
library(stats)
library(ape)
library(reshape2)
library(geomorph)
library(caper)
library(geiger)
library(nlme)

##### Read input files #####

#Matrices of log(cpm) within each cell population
lograwCounts<-readRDS(paste0(path_to_output_of_integration,'logcpm_byCellType.rds'))

data <- lapply(lograwCounts, function(x) t(x))
data <- lapply(data, function(x) x[rownames(x)!='Astbur',])
data <- lapply(data, function(x) x[rownames(x)!='Orenil',])

##Time-calibrated species tree


#Ecological predictors
ecological_predictors <- readRDS(paste0(path_to_output_of_integration,'ecological_predictors.rds'))

#Make sure order of ecological predictors and data match order of tree tips

ecological_predictors <- lapply(seq_along(ecological_predictors), function(i) ecological_predictors[[i]][tree[[i]]$tip.label,])

#Functions to perform linear model and pGLS with Brownian Motion
#Linear model
function_lm <- function(Data,g) {
    summary(lm(Data[,1] ~ Data[,g]))$coefficients[2,4]
}

#pGLS Brownian Motion
function_gls_bm <- function(Data,Tree,g) {
    formula <- as.formula(paste0(names(Data)[1], " ~ ", names(Data)[g]))
    mod1 <- try(gls(formula,data=Data,correlation = corBrownian(value=1,phy=Tree[[n_CellType]],form = ~species),method='ML'))
    if (class(mod1) == "try-error") {
        return(NA)
    } else {
        mod=summary(mod1)
        p = mod$tTable[2,4]
        return(p)
    }
}

#Run these functions for each gene expressed in each cell population
lm_data_genes <- lapply(data_genes, function(x) unlist(lapply(2:3, function(i) function_lm(x,i))))
gls_bm_data_genes <- lapply(data_genes, function(x) unlist(lapply(2:3, function(i) function_gls_bm(x,tree,i))))




