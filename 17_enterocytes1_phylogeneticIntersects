#!/usr/bin/env Rscript
#Script 17. R script for identifying ecologically relevant genes in enterocytes 1

library(Seurat)
library(dplyr)
library(stats)
library(ape)
library(reshape2)
library(geomorph)
library(caper)
library(geiger)
library(nlme)

##### Read input files #####

#Matrices of log(cpm) within each cell population
lograwCounts<-readRDS(paste0(path_to_output_of_integration,'logcpm_byCellType.rds'))

#Restrict to genes expressed in at least 20% of cells

##Time-calibrated species tree
tree <- readRDS(paste0(path_to_output_of_integration,'tree_byCellType.rds'))

#Ecological predictors
ecological_predictors <- readRDS(paste0(path_to_output_of_integration,'ecological_predictors.rds'))

#Make sure order of ecological predictors and data match order of tree tips
lograwCounts <- lapply(seq_along(lograwCounts), function(i) lograwCounts[[i]][tree[[i]]$tip.label,])
ecological_predictors <- lapply(lograwCounts, function(x) ecological_predictors[ecological_predictors$species %in% colnames(x),])
ecological_predictors <- lapply(seq_along(ecological_predictors), function(i) ecological_predictors[[i]][tree[[i]]$tip.label,])

#Functions to perform linear model and pGLS with Brownian Motion
#Linear model
function_lm <- function(Data,g) {
    summary(lm(Data[,1] ~ Data[,g]))$coefficients[2,4]
}

#pGLS Brownian Motion
function_gls_bm <- function(Data,Tree,g) {
    formula <- as.formula(paste0(names(Data)[1], " ~ ", names(Data)[g]))
    mod1 <- try(gls(formula,data=Data,correlation = corBrownian(value=1,phy=Tree[[n_CellType]],form = ~species),method='ML'))
    if (class(mod1) == "try-error") {
        return(NA)
    } else {
        mod=summary(mod1)
        p = mod$tTable[2,4]
        return(p)
    }
}

data_byGene <- lapply(lograwCounts, function(x) (seq_along(colnames(x)), as.data.frame(function(i) x[,i,drop=F])))

#Function to prepare data for lm and pGLS
function_prepare <- function(data,i) {
    data$d15N <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$d15N
    data$d13C <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$d13C
    data$ratio <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$ratio
    data$LPJ_PC2 <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$LPJ_PC2
    data$oral_PC1 <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$oral_PC1
    data$diet_ecology_vector <- ecological_predictors[[i]][match(rownames(data),rownames(ecological_predictors[[i]]),]$diet_ecology_vector
    data$species <- rownames(data)
    colnames(data) <- c('gene','d15N','d13C','ratio','LPJ_PC2','oral_PC1','diet_ecology_vector','species')
    data <- data[tree[[i]]$tip.label,]
    return(data)
}

#Use this function to get all data ready
data_final <- lapply(seq_along(data_byGene), function(i) lapply(data_byGene[[i]], function(x) function_prepare(x,i)))

#Run the lm and pGLS functions for each gene expressed in each cell population


lm_data_genes <- lapply(data_final, function(x) unlist(lapply(2:3, function(i) function_lm(x,i))))
gls_bm_data_genes <- lapply(data_final, function(x) unlist(lapply(2:3, function(i) function_gls_bm(x,tree,i))))




